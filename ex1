
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import re

from sklearn.model_selection import train_test_split, GridSearchCV
from sklearn.linear_model import LinearRegression, Ridge, Lasso, ElasticNet
from sklearn.preprocessing import PolynomialFeatures, StandardScaler, LabelEncoder
from sklearn.pipeline import Pipeline
from sklearn.metrics import mean_squared_error, r2_score

df = pd.read_csv('used_cars.csv')
print("ابعاد اولیه:", df.shape)
print("ستون‌ها:", df.columns.tolist())
print("\nاطلاعات داده:\n")
df.info()

# حذف رکوردهای تکراری
df = df.dropna(subset=['selling_price'])

# تبدیل ستون‌های عددی که به صورت متنی با واحد هستند
def extract_numeric(value, unit_pattern):
    """استخراج عدد اول از رشته شامل واحد"""
    if pd.isna(value):
        return np.nan
    match = re.search(r'(\d+\.?\d*)', str(value))
    return float(match.group(1)) if match else np.nan


df['mileage_num'] = df['mileage'].apply(lambda x: extract_numeric(x, r'[\d\.]+'))

df['engine_num'] = df['engine'].apply(lambda x: extract_numeric(x, r'[\d\.]+'))


df['max_power_num'] = df['max_power'].apply(lambda x: extract_numeric(x, r'[\d\.]+'))


df['seats'] = pd.to_numeric(df['seats'], errors='coerce')

current_year = 2020
df['age'] = current_year - df['year']

label_encoders = {}
categorical_cols = ['fuel', 'seller_type', 'transmission', 'owner']
for col in categorical_cols:
    le = LabelEncoder()
    df[col + '_enc'] = le.fit_transform(df[col].astype(str))
    label_encoders[col] = le

# انتخاب ویژگی‌های نهایی برای مدل‌سازی
# متغیر هدف: selling_price
# ویژگی‌های عددی: age, km_driven, mileage_num, engine_num, max_power_num, seats, و کدهای categorical
feature_cols = ['age', 'km_driven', 'mileage_num', 'engine_num', 'max_power_num', 'seats'] + \
               [col + '_enc' for col in categorical_cols]

# حذف رکوردهای دارای مقدار گمشده در ویژگی‌ها یا هدف
df_model = df[feature_cols + ['selling_price']].dropna()
print("\nتعداد رکورد پس از پاکسازی:", df_model.shape[0])

# جدا کردن ویژگی‌ها و هدف
X = df_model[feature_cols]
y = df_model['selling_price']

# توزیع قیمت
plt.figure(figsize=(10, 4))
plt.subplot(1, 2, 1)
sns.histplot(y, bins=50, kde=True)
plt.title('توزیع قیمت فروش')

# رابطه سن خودرو و قیمت
plt.subplot(1, 2, 2)
sns.scatterplot(x=df_model['age'], y=y, alpha=0.5)
plt.title('سن خودرو در مقابل قیمت')
plt.tight_layout()
plt.show()

# ماتریس همبستگی بین ویژگی‌های عددی
numeric_for_corr = df_model[['age', 'km_driven', 'mileage_num', 'engine_num', 'max_power_num', 'seats', 'selling_price']]
plt.figure(figsize=(10, 8))
sns.heatmap(numeric_for_corr.corr(), annot=True, cmap='coolwarm', fmt='.2f')
plt.title('همبستگی بین ویژگی‌ها و هدف')
plt.show()

# تقسیم داده ها به اموزش و ازمون
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)
print(f"\nاندازه مجموعه آموزش: {X_train.shape}")
print(f"اندازه مجموعه آزمون: {X_test.shape}")

# استاندارد سازی 
scaler = StandardScaler()
X_train_scaled = scaler.fit_transform(X_train)
X_test_scaled = scaler.transform(X_test)

# برای رگرسیون خطی تک‌متغیره، فقط یک ویژگی را انتخاب می‌کنیم (مثلاً age)
X_train_univariate = X_train[['age']]
X_test_univariate = X_test[['age']]
# همچنین برای چندجمله‌ای تک‌متغیره از همین ویژگی استفاده می‌کنیم

#اموزش مدرها
models = {}
results = {}

#رگرسیون خطی چند متغیره
model = LinearRegression()
model.fit(X_train_univariate, y_train)
y_pred = model.predict(X_test_univariate)
mse = mean_squared_error(y_test, y_pred)
r2 = r2_score(y_test, y_pred)
models['Univariate Linear'] = model
results['Univariate Linear'] = {'MSE': mse, 'R2': r2}
print("\n--- Univariate Linear ---")
print(f"MSE: {mse:.2f}, R2: {r2:.4f}")

#  رگرسیون خطی چندمتغیره
model = LinearRegression()
model.fit(X_train_scaled, y_train)
y_pred = model.predict(X_test_scaled)
mse = mean_squared_error(y_test, y_pred)
r2 = r2_score(y_test, y_pred)
models['Multivariate Linear'] = model
results['Multivariate Linear'] = {'MSE': mse, 'R2': r2}
print("\n--- Multivariate Linear ---")
print(f"MSE: {mse:.2f}, R2: {r2:.4f}")

# رگرسیون چند جمله ای 
# برای سادگی از PolynomialFeatures با درجه ۲ روی داده‌های استاندارد استفاده می‌کنیم
poly = PolynomialFeatures(degree=2, include_bias=False)
X_train_poly = poly.fit_transform(X_train_scaled)
X_test_poly = poly.transform(X_test_scaled)

model = LinearRegression()
model.fit(X_train_poly, y_train)
y_pred = model.predict(X_test_poly)
mse = mean_squared_error(y_test, y_pred)
r2 = r2_score(y_test, y_pred)
models['Polynomial (deg=2)'] = model
results['Polynomial (deg=2)'] = {'MSE': mse, 'R2': r2}
print("\n--- Polynomial Regression (degree=2) ---")
print(f"MSE: {mse:.2f}, R2: {r2:.4f}")

# Ridge Regression 
param_grid = {'alpha': [0.01, 0.1, 1, 10, 100]}
ridge = Ridge()
grid_ridge = GridSearchCV(ridge, param_grid, cv=5, scoring='r2')
grid_ridge.fit(X_train_scaled, y_train)
best_ridge = grid_ridge.best_estimator_
y_pred = best_ridge.predict(X_test_scaled)
mse = mean_squared_error(y_test, y_pred)
r2 = r2_score(y_test, y_pred)
models['Ridge (tuned)'] = best_ridge
results['Ridge (tuned)'] = {'MSE': mse, 'R2': r2}
print("\n--- Ridge Regression ---")
print(f"Best alpha: {grid_ridge.best_params_['alpha']}")
print(f"MSE: {mse:.2f}, R2: {r2:.4f}")

# Lasso Regression 
lasso = Lasso(max_iter=10000)
grid_lasso = GridSearchCV(lasso, param_grid, cv=5, scoring='r2')
grid_lasso.fit(X_train_scaled, y_train)
best_lasso = grid_lasso.best_estimator_
y_pred = best_lasso.predict(X_test_scaled)
mse = mean_squared_error(y_test, y_pred)
r2 = r2_score(y_test, y_pred)
models['Lasso (tuned)'] = best_lasso
results['Lasso (tuned)'] = {'MSE': mse, 'R2': r2}
print("\n--- Lasso Regression ---")
print(f"Best alpha: {grid_lasso.best_params_['alpha']}")
print(f"MSE: {mse:.2f}, R2: {r2:.4f}")

# 5.6 ElasticNet
elastic = ElasticNet(max_iter=10000)
param_grid_elastic = {'alpha': [0.01, 0.1, 1, 10], 'l1_ratio': [0.2, 0.5, 0.8]}
grid_elastic = GridSearchCV(elastic, param_grid_elastic, cv=5, scoring='r2')
grid_elastic.fit(X_train_scaled, y_train)
best_elastic = grid_elastic.best_estimator_
y_pred = best_elastic.predict(X_test_scaled)
mse = mean_squared_error(y_test, y_pred)
r2 = r2_score(y_test, y_pred)
models['ElasticNet (tuned)'] = best_elastic
results['ElasticNet (tuned)'] = {'MSE': mse, 'R2': r2}
print("\n--- ElasticNet ---")
print(f"Best params: {grid_elastic.best_params_}")
print(f"MSE: {mse:.2f}, R2: {r2:.4f}")

# جدول نتایج
results_df = pd.DataFrame(results).T
print("\n\nنتایج ارزیابی مدل‌ها روی داده آزمون:")
print(results_df)

# نمودار مقایسه R-squared
plt.figure(figsize=(10, 5))
plt.subplot(1, 2, 1)
bars = plt.bar(results_df.index, results_df['R2'], color='skyblue')
plt.xticks(rotation=45, ha='right')
plt.ylabel('R-squared')
plt.title('مقایسه R-squared مدل‌ها')
plt.ylim(0, 1)

# نمودار مقایسه MSE
plt.subplot(1, 2, 2)
bars = plt.bar(results_df.index, results_df['MSE'], color='salmon')
plt.xticks(rotation=45, ha='right')
plt.ylabel('MSE')
plt.title('مقایسه MSE مدل‌ها')
plt.tight_layout()
plt.show()

# نمودار پراکندگی مقادیر واقعی و پیش‌بینی برای بهترین مدل (بر اساس R2)
best_model_name = results_df['R2'].idxmax()
best_model = models[best_model_name]
if best_model_name == 'Univariate Linear':
    X_test_best = X_test_univariate
else:
    # برای مدل‌های دیگر باید از داده مقیاس‌شده یا چندجمله‌ای متناسب استفاده کنیم
    if best_model_name == 'Polynomial (deg=2)':
        y_pred_best = best_model.predict(X_test_poly)
    else:
        # Ridge, Lasso, ElasticNet, Multivariate از X_test_scaled استفاده می‌کنند
        y_pred_best = best_model.predict(X_test_scaled)

# برای مدل تک‌متغیره و چندمتغیره معمولی
if best_model_name == 'Univariate Linear':
    X_plot = X_test_univariate
elif best_model_name == 'Multivariate Linear':
    y_pred_best = best_model.predict(X_test_scaled)
elif best_model_name == 'Polynomial (deg=2)':
    y_pred_best = best_model.predict(X_test_poly)
else:
    y_pred_best = best_model.predict(X_test_scaled)

plt.figure(figsize=(6, 6))
plt.scatter(y_test, y_pred_best, alpha=0.5)
plt.plot([y_test.min(), y_test.max()], [y_test.min(), y_test.max()], 'r--')
plt.xlabel('قیمت واقعی')
plt.ylabel('قیمت پیش‌بینی شده')
plt.title(f'بهترین مدل: {best_model_name} (R2 = {results_df.loc[best_model_name, "R2"]:.3f})')
plt.tight_layout()
plt.show()

print("\nپایان اجرا.")